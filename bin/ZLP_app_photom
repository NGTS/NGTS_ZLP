#!/usr/local/python/bin/python
# -*- coding: utf-8 -*-

"""
 
Zero Level Pipeline apperture photometry 

Usage: 
  ZLP_app_photom [-h] [--verbose] [--nproc=NPROC] [--appsize=APPSIZE] [--s_thresh=S_THRESH] (--confmap=CONFMAP) (--catfile=CATFILE) (--filelist=FILELIST | INPUT ...) [--outlist=OUTLIST]

Options:
  -h --help              Show help text
  --verbose              Print more text
  --catfile=CATFILE      The catalog file for this field
  --confmap=CONFMAP      The confidence map (callibration product)
  --filelist=FILELIST    Specify a filelist to use instead of command line
  --outlist=OUTLIST      Specify the name of the list of completed files
  --nproc=NPROC          Enable multithreading if you're analysing a lot of files at once [default: 1]
  --appsize=APPSIZE      The radius of the apperture you wish to use in the photometry stage [default: 2]
  --s_thresh=S_THRESH    The detection threshold to use when WCS solving images - typically higher than when doing actual photometry [default: 20]

This is the apperture photometry portion of the pipeline. It can be driven either in a list mode
or on a single file
 
"""
from docopt import docopt
import sys
import linecache
from numpy import *
import threading
from os.path import isfile, join
from NGTS_workpackage import *

arguments = docopt(__doc__)

#if you don't provide an outlist name i'll assume you just want to add _phot to the end
if not arguments['--outlist']:
  arguments['--outlist'] = arguments['--filelist'] + '_phot'

outfile = open(arguments['--outlist'],'w')
outfile.close()


if arguments['--filelist']:
#  m_call_ZLP(arguments['--filelist'],arguments['--outlist'],arguments['--confmap'],arguments['--catfile'],arguments['--appsize'],int(arguments['--nproc']),arguments['--s_thresh'],verbose=arguments['--verbose'])
  m_condense_data(arguments['--filelist'],int(arguments['--nproc']),int(arguments['--appsize']))

if arguments['INPUT']:
  for filename in arguments['INPUT']:
    casu_solve(filename,arguments['--s_thresh'],verbose=arguments['--verbose'])
    casu_photom(filename,arguments['--confmap'],arguments['--catfile'],arguments['--appsize'],verbose=arguments['--verbose'])
