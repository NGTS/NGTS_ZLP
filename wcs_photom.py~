# -*- coding: utf-8 -*-
import pyfits as pf
import os
import linecache
import threading
from os.path import isfile, join
from util import thread_alloc

def m_wcs_photom(nproc,nfiles,nice,conf_dir,cat_dir,appsize):

  starts, ends = thread_alloc(nfiles,nproc)

  threads = []
  for i in range(0,nproc):
    t = threading.Thread(target=wcs_photom, args = (starts[i],ends[i],i+1,nice,conf_dir,cat_dir,appsize))
    threads.append(t)
  [x.start() for x in threads]
  [x.join() for x in threads]

def wcs_photom(minlen,maxlen,thread,niced,conf_dir,cat_dir,appsize):

  nice =''
  if niced==True:
    nice = '/usr/bin/nice -n20 '

  for i in range(minlen,maxlen):
    percent = 100*((i+1)-minlen)/(maxlen-minlen)
    raw_image = linecache.getline('filelist',i).rstrip('\n')
    image = raw_image.split('/')[-1].strip('.fits') + '_cal.fits'
    outname = image.rstrip('.new').split('/')[-1]+'.phot'
    screen = nice + 'imcore_list '+image+' '+conf_dir+'confidence.fits '+cat_dir+'catfile.fits '+outname+' 1.25 --rcore='+str(appsize)+' --noell'
    print screen
    os.system(screen)
    print 'process ',thread,' ',percent,'% complete'

  linecache.clearcache()